<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title th:utext="${pageTitle}">Reset Password</title>
	<link rel="stylesheet" href="../css/style.css" />
	<style>
		body {
			font-family: sans-serif;
			margin: 0;
			padding: 0;
			display: flex;
			justify-content: center;
			align-items: center;
			min-height: 100vh;
		}

		#cas-box {
			width: 400px;
			margin: 0 auto;
			padding: 2em;
			background-color: #FFFFFF;
			border: 1px solid rgb(192, 192, 192);
			border-radius: 8px;
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
			text-align: center;
		}

		#cas-box img {
			max-width: 100px;
			margin-bottom: 1em;
		}

		main h2 {
			margin-bottom: 1em;
		}

		form {
			display: flex;
			flex-direction: column;
			gap: 1em;
		}

		label {
			font-weight: bold;
			text-align: start;
			font-size: small;
		}

		input,
		button {
			padding: 0.5em 1em;
			border: 1px solid #ccc;
			border-radius: 4px;
		}

		button {
			cursor: pointer;
		}

		.forgot-password-link {
			text-decoration: none;
			color: #333;
		}
		
		.overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black */
            z-index: 9998; /* Ensure the overlay appears behind the popup */
        }

        /* Styles for the popup */
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding-left: 40px;
            padding-right: 40px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 9999;
        }
	</style>
    
</head>

<body th:style="${backgroundImageUrl} ? 'background: url(' + ${backgroundImageUrl} + ') center/cover no-repeat;' : 'background-color: ' + ${backgroundColorCode} + ';'">
	
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
		
		function showPopup(message, showButton) {
		    document.getElementById('overlay').style.display = 'block';
		    document.getElementById('popup').style.display = 'block';
		    changeContentOfPopup(message, showButton)
		    document.body.style.overflow = 'hidden';
		}
		
		function changeContentOfPopup(message, showButton) {
		    document.getElementById('popupMessage').innerText = message;
		    if (showButton){
				document.getElementById('popupButton').style.display = 'block';
				document.getElementById('popup').style.paddingBottom = '30px';

			}else{
				document.getElementById('popupButton').style.display = 'none';
				document.getElementById('popup').style.paddingBottom = '0px';
			}
		}
		
		function goToLoginPage(hostUrl) {
		    // Redirect to login page using the hostUrl
            var location = window.location.protocol + "//" + window.location.hostname + ((window.location.port)?(":" + window.location.port):"");
            location = location? (location + "/login?hostUrl=" + hostUrl): "";
            
            window.location.href = location;
		}
		
		function closePopup() {
		    document.getElementById('overlay').style.display = 'none';
		    document.getElementById('popup').style.display = 'none';
		    document.body.style.overflow = 'auto';
		}


		
		$(document).ready(function() {
		    $('#resetPasswordForm').submit(function(event) {
				$('#errorMessage').html("");
		        // Prevent the default form submission
		        event.preventDefault();
		
		        // Disable the form and button to prevent multiple submissions
		        $('#resetPasswordBtn').prop('disabled', true);
		
				var csrfToken = $('#csrfToken').val();
				showPopup("Please wait ...", false);

		        var formData = {
		            jwtToken: $('#jwtToken').val(),
		            hostUrl: $('#hostUrl').val(),
		            newPassword: $('#newPassword').val(),
		            confirmPassword: $('#confirmPassword').val()
		        };
		        		
		        $.ajax({
		            type: 'POST',
		            url: '/password/reset',
				    beforeSend: function(xhr) {
				        xhr.setRequestHeader('X-CSRF-TOKEN', csrfToken);
				    },
		            data: formData,
		            success: function(response) {
						changeContentOfPopup(response, true);

		            },
		            error: function(xhr, status, error) {
		                $('#resetPasswordBtn').prop('disabled', false);
		                $('#errorMessage').html(xhr.responseText);
		                closePopup();
		            }
		        });
		    });
		    
		});
		
	</script>
	
	<main>
		<div id="cas-box">
			<img th:src="${logoUrl}" th:alt="${clientDisplayName}">
			<h4 th:text="${clientDisplayName}"></h4>
			
			
			<h4 style="text-align: left;" th:utext="${pageTitle}"></h4>
			<p th:utext="${pageDescription}" style="text-align: left; font-size: small; margin-bottom: 3em;"></p>

			<!-- Display error message if authentication fails -->
			<div id="errorMessage" style="color: red; font-size: small; margin-bottom: 1em;"></div>

			<form id="resetPasswordForm" th:object="${loginForm}">
				
				<input id="csrfToken" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" id="hostUrl" name="hostUrl" th:value="${hostUrl}" />
                <input type="hidden" id="jwtToken" name="jwtToken" th:value="${token}" />
                
                <label for="newPassword">New Password:</label>
                <input type="password" id="newPassword" name="newPassword" autocomplete="new-password" required>
                
                <label for="confirmPassword">Confirm Password:</label>
                <input type="password" id="confirmPassword" name="confirmPassword" autocomplete="new-password" required>
                
                <button type="submit" id="resetPasswordBtn" th:utext="${pageTitle}"></button>
            </form>

		</div>
		
		<!-- Overlay -->
		<div id="overlay" class="overlay"></div>
		
		<div id="popup" class="popup">
		    <h4 id="popupMessage"></h4>
		    <button id="popupButton" th:onclick="goToLoginPage([[${hostUrl}]])" type="button" style="display: none; position: absolute; top: 50px; right: 10px; left: 10px; bottom: 10px;">ok</button>
		</div>

	</main>
	
</body>

</html>